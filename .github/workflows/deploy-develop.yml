name: Deploy to develop

on:
  push:
    branches:
      - main
    paths:
      - config/parameters/**/develop.json
      - config/develop.json
  workflow_dispatch:

permissions:
  id-token: write

concurrency:
  group: deploy-develop
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: develop
      url: https://dev-www.nationalarchives.gov.uk/
    strategy:
      matrix:
        service:
          - frontend
          - enrichment
          - wagtail
          - catalogue
          - search
          - wagtaildocs
          - requestservicerecord
          
    timeout-minutes: 15
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: eu-west-2
          role-to-assume: arn:aws:iam::846769538626:role/GithubOIDCProviderIAMRolePermissions-Role-I80RXHT6O1PL
          role-session-name: GitHubActionsSession

      - name: Update SSM parameters for ${{ matrix.service }}
        run: |
          FILE="config/parameters/${{ matrix.service }}/develop.json"
          PARAM_PATH="/application/web/${{ matrix.service }}"

          if [ ! -f "$FILE" ]; then
            echo "âŒ $FILE not found, skipping ${{ matrix.service }}"
            exit 0
          fi

          echo "ðŸ”„ Updating $PARAM_PATH from $FILE"
          FORMATTED_JSON=$(jq '.' "$FILE")

          aws ssm put-parameter \
            --name "$PARAM_PATH" \
            --type String \
            --value "$FORMATTED_JSON" \
            --overwrite

          echo "âœ… ${{ matrix.service }} parameters updated"


      - uses: actions/checkout@v4

      - name: Deploy service
        uses: ./.github/actions/deploy
        with:
          config-file: develop.json
          service-name: ${{ matrix.service }}
          aws-role: arn:aws:iam::846769538626:role/GithubOIDCProviderIAMRolePermissions-Role-I80RXHT6O1PL
          parameter-path: /application/web/${{ matrix.service }}/docker_images
          deployed-parameter-path: /application/web/${{ matrix.service }}/deployed_version

  tests:
    runs-on: ubuntu-latest
    needs:
      - deploy
    env:
      GH_TOKEN: ${{ secrets.ACTIONS_GITHUB_TOKEN_TEST_RUNNER }}
    steps:
      - uses: actions/checkout@v4

      - name: Run tests
        run: |
          HOUR=$(date +"%H")
          DAY_OF_WEEK=$(date +%u)
          if [ "$HOUR" -ge 9 ] && [ "$HOUR" -le 17 ] && [ "$DAY_OF_WEEK" -ge 1 ] && [ "$DAY_OF_WEEK" -le 5 ];
          then
            echo "Running tests during working hours"
            gh workflow run run.yml --repo nationalarchives/ds-tna-website-tests --raw-field domain=https://dev-www.nationalarchives.gov.uk --raw-field exclude-tests="@wip|@requires-wordpress" --raw-field notify-slack-on-pass=false --raw-field notify-slack-on-fail=true --raw-field description="$(git log -1 --pretty=%B | sed '/./,$!d' | sed '/^$/d' | sed 's/^/> /')"
            sleep 5
            gh run watch --exit-status --repo nationalarchives/ds-tna-website-tests $(gh run list --repo nationalarchives/ds-tna-website-tests --workflow run.yml -L1 --json databaseId --jq .[0].databaseId)
          else
            echo "Skipping tests outside working hours"
          fi
