name: Update Web IP Set
on:
  workflow_dispatch:
    inputs:
      new_ip:
        description: 'Enter your new IP/CIDR (mandatory, e.g., 203.0.113.5/32 or 10.0.0.0/24)'
        required: true
      old_ip:
        description: 'Enter old IP/CIDR to delete (optional)'
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  update-web-ip-set:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install boto3
        run: pip install boto3

      - name: Update WAF IP Sets for Dev and Staging
        run: |
          python3 - <<EOF
          import boto3

          new_ip = '${{ github.event.inputs.new_ip }}'.strip()
          old_ip = '${{ github.event.inputs.old_ip }}'.strip()

          if not new_ip:
              print("New IP/CIDR is mandatory!")
              exit(1)

          envs = {
              'dev': {
                  'ip_set_id': '058768bc-eb34-41ba-82e8-3a2e0768184b',
                  'role_arn': 'arn:aws:iam::846769538626:role/GithubOIDCProviderIAMRolePermissions-Role-I80RXHT6O1PL'
              },
              'staging': {
                  'ip_set_id': 'eb3183da-cb52-4788-8d0d-00bed2675808',
                  'role_arn': 'arn:aws:iam::337670467269:role/GitHubActionRole'
              }
          }

          for env, data in envs.items():
              print(f"\nProcessing environment: {env}")
              sts = boto3.client('sts')
              creds = sts.assume_role(
                  RoleArn=data['role_arn'],
                  RoleSessionName=f'GitHubActions-{env}'
              )['Credentials']

              session = boto3.session.Session(
                  aws_access_key_id=creds['AccessKeyId'],
                  aws_secret_access_key=creds['SecretAccessKey'],
                  aws_session_token=creds['SessionToken'],
                  region_name='us-east-1'
              )

              waf = session.client('wafv2')

              resp = waf.get_ip_set(
                  Name='wp-website-access',
                  Scope='CLOUDFRONT',
                  Id=data['ip_set_id']
              )
              lock_token = resp['LockToken']
              addresses = resp['IPSet']['Addresses']

              if new_ip in addresses:
                  print(f"[{env}] IP/CIDR {new_ip} already exists.")
              else:
                  addresses.append(new_ip)
                  print(f"[{env}] IP/CIDR {new_ip} added.")

              if old_ip:
                  if old_ip in addresses:
                      addresses.remove(old_ip)
                      print(f"[{env}] Old IP/CIDR {old_ip} removed.")
                  else:
                      print(f"[{env}] Old IP/CIDR {old_ip} not found.")
   
              waf.update_ip_set(
                  Name='wp-website-access',
                  Scope='CLOUDFRONT',
                  Id=data['ip_set_id'],
                  Addresses=addresses,
                  LockToken=lock_token
              )

              print(f"[{env}] IP set update completed.")
          EOF
