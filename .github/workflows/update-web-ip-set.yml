name: Update Web IP Set

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select environment'
        required: true
        type: choice
        options:
          - dev
          - staging
      new_ip:
        description: 'Enter your new IP/CIDR (mandatory, e.g., 203.0.113.5/32 or 10.0.0.0/24)'
        required: true
      old_ip:
        description: 'Enter old IP/CIDR to delete (optional)'
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  update-web-ip-set:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set AWS Role
        id: set-role
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
            echo "role=arn:aws:iam::846769538626:role/GithubOIDCProviderIAMRolePermissions-Role-I80RXHT6O1PL" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            echo "role=arn:aws:iam::337670467269:role/GitHubActionRole" >> $GITHUB_OUTPUT
          else
            echo "Invalid environment"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: ${{ steps.set-role.outputs.role }}
          role-session-name: GitHubActionsSession
          audience: sts.amazonaws.com
          output-env-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install boto3
        run: pip install boto3

      - name: Update WAF IP Set
        run: |
          python3 - <<EOF
          import boto3, os

          waf = boto3.client('wafv2', region_name='us-east-1')

          env = '${{ github.event.inputs.environment }}'.lower()
          new_ip = '${{ github.event.inputs.new_ip }}'.strip()
          old_ip = '${{ github.event.inputs.old_ip }}'.strip()

          if not new_ip:
              print("New IP/CIDR is mandatory!")
              exit(1)

          env_ip_sets = {
              'dev': '058768bc-eb34-41ba-82e8-3a2e0768184b',
              'staging': 'eb3183da-cb52-4788-8d0d-00bed2675808'
          }

          if env not in env_ip_sets:
              print("Invalid environment")
              exit(1)

          ip_set_id = env_ip_sets[env]

          resp = waf.get_ip_set(Name='wp-website-access', Scope='CLOUDFRONT', Id=ip_set_id)
          lock_token = resp['LockToken']
          addresses = resp['IPSet']['Addresses']

          if new_ip in addresses:
              print(f"IP/CIDR {new_ip} already exists in {env} environment.")
          else:
              addresses.append(new_ip)
              print(f"IP/CIDR {new_ip} added to {env} environment.")

          if old_ip:
              if old_ip in addresses:
                  addresses.remove(old_ip)
                  print(f"Old IP/CIDR {old_ip} removed from {env} environment.")
              else:
                  print(f"Old IP/CIDR {old_ip} not found in {env} environment.")

          waf.update_ip_set(
              Name='wp-website-access',
              Scope='CLOUDFRONT',
              Id=ip_set_id,
              Addresses=addresses,
              LockToken=lock_token
          )

          print(f"IP set update completed for {env} environment.")
          EOF
